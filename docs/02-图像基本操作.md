# 图像基本操作

## 学习目标

- 掌握像素的访问与修改
- 学会图像的裁剪、缩放、翻转
- 理解图像的算术运算
- 掌握图像通道的分离与合并

---

## 一、像素访问与修改

### 1.1 访问单个像素

**语法：**
```python
pixel_value = img[y, x]  # 注意：先行后列
```

**示例：**
```python
import cv2
import numpy as np

# 创建一个3x3的彩色图像
img = np.zeros((300, 300, 3), dtype=np.uint8)

# 访问单个像素（返回BGR三通道值）
pixel = img[100, 100]
print(f"像素值: {pixel}")  # [0, 0, 0]

# 访问灰度图的像素
gray = np.zeros((300, 300), dtype=np.uint8)
pixel_gray = gray[100, 100]
print(f"灰度像素值: {pixel_gray}")  # 0
```

### 1.2 访问指定通道

```python
import cv2
img = cv2.imread('photo.jpg')

# 访问像素的蓝色通道（索引0）
blue = img[100, 100, 0]

# 访问绿色通道（索引1）
green = img[100, 100, 1]

# 访问红色通道（索引2）
red = img[100, 100, 2]

print(f"BGR值: ({blue}, {green}, {red})")
```

### 1.3 修改像素值

```python
import cv2
import numpy as np

img = np.zeros((300, 300, 3), dtype=np.uint8)

# 修改单个像素为白色
img[100, 100] = [255, 255, 255]

# 修改像素的红色通道
img[100, 100, 2] = 255

# 修改多个像素（区域）
img[50:100, 50:100] = [255, 0, 0]  # 蓝色方块
```

### 1.4 批量修改（ROI - Region of Interest）

```python
import cv2

img = cv2.imread('photo.jpg')

# 选择区域（ROI）
roi = img[100:200, 150:250]  # [y1:y2, x1:x2]

# 将ROI复制到其他位置
img[300:400, 300:400] = roi

# 修改ROI为纯色
img[0:50, 0:50] = [0, 0, 255]  # 红色方块
```

---

## 二、图像裁剪（ROI提取）

**语法：**
```python
cropped = image[y1:y2, x1:x2]
```

**示例：**
```python
import cv2

img = cv2.imread('photo.jpg')

# 获取图像尺寸
height, width = img.shape[:2]

# 裁剪中心区域
start_y, start_x = height // 4, width // 4
end_y, end_x = start_y * 3, start_x * 3

cropped = img[start_y:end_y, start_x:end_x]

cv2.imshow('Original', img)
cv2.imshow('Cropped', cropped)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

**应用场景：**
- 提取图像中的特定区域
- 人脸检测后裁剪人脸
- 关注图像的重要部分

---

## 三、图像缩放

### 3.1 指定尺寸缩放

**语法：**
```python
resized = cv2.resize(src, dsize, fx, fy, interpolation)
```

**参数：**
- `src`：输入图像
- `dsize`：输出尺寸 (width, height)
- `fx, fy`：水平/垂直缩放因子
- `interpolation`：插值方法

**示例：**
```python
import cv2

img = cv2.imread('photo.jpg')

# 方式1：指定具体尺寸
resized_1 = cv2.resize(img, (640, 480))  # (width, height)

# 方式2：使用缩放因子
resized_2 = cv2.resize(img, None, fx=0.5, fy=0.5)  # 缩小50%

# 方式3：保持宽高比缩放
height, width = img.shape[:2]
new_width = 800
scale = new_width / width
new_height = int(height * scale)
resized_3 = cv2.resize(img, (new_width, new_height))

cv2.imshow('Original', img)
cv2.imshow('Resized', resized_2)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 3.2 插值方法

```python
# 缩小图像（推荐INTER_AREA）
small = cv2.resize(img, None, fx=0.5, fy=0.5,
                   interpolation=cv2.INTER_AREA)

# 放大图像（推荐INTER_CUBIC或INTER_LINEAR）
large = cv2.resize(img, None, fx=2.0, fy=2.0,
                   interpolation=cv2.INTER_CUBIC)
```

**常用插值方法：**
- `cv2.INTER_LINEAR`：双线性插值（默认）
- `cv2.INTER_CUBIC`：双三次插值（质量更好，速度慢）
- `cv2.INTER_AREA`：区域插值（缩小推荐）
- `cv2.INTER_NEAREST`：最近邻插值（最快，质量差）

---

## 四、图像翻转

### 4.1 水平/垂直翻转

**语法：**
```python
flipped = cv2.flip(src, flipCode)
```

**参数：**
- `flipCode = 0`：垂直翻转（沿x轴）
- `flipCode > 0`：水平翻转（沿y轴）
- `flipCode < 0`：同时水平和垂直翻转

**示例：**
```python
import cv2

img = cv2.imread('photo.jpg')

# 水平翻转（镜像）
flip_horizontal = cv2.flip(img, 1)

# 垂直翻转
flip_vertical = cv2.flip(img, 0)

# 同时水平和垂直翻转
flip_both = cv2.flip(img, -1)

cv2.imshow('Original', img)
cv2.imshow('Horizontal Flip', flip_horizontal)
cv2.imshow('Vertical Flip', flip_vertical)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 五、图像平移

**语法：**
```python
M = np.float32([[1, 0, tx], [0, 1, ty]])
shifted = cv2.warpAffine(src, M, (width, height))
```

**参数：**
- `tx`：x方向平移像素
- `ty`：y方向平移像素

**示例：**
```python
import cv2
import numpy as np

img = cv2.imread('photo.jpg')
height, width = img.shape[:2]

# 向右平移100像素，向下平移50像素
M = np.float32([[1, 0, 100], [0, 1, 50]])
shifted = cv2.warpAffine(img, M, (width, height))

cv2.imshow('Original', img)
cv2.imshow('Shifted', shifted)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 六、图像旋转

**语法：**
```python
M = cv2.getRotationMatrix2D(center, angle, scale)
rotated = cv2.warpAffine(src, M, (width, height))
```

**参数：**
- `center`：旋转中心 (x, y)
- `angle`：旋转角度（度，正值为逆时针）
- `scale`：缩放因子

**示例：**
```python
import cv2
import numpy as np

img = cv2.imread('photo.jpg')
height, width = img.shape[:2]

# 围绕中心旋转45度，缩放1倍
center = (width // 2, height // 2)
M = cv2.getRotationMatrix2D(center, 45, 1.0)
rotated = cv2.warpAffine(img, M, (width, height))

# 旋转90度（简单方法）
rotated_90 = cv2.rotate(img, cv2.ROTATE_90_CLOCKWISE)

cv2.imshow('Original', img)
cv2.imshow('Rotated 45°', rotated)
cv2.imshow('Rotated 90°', rotated_90)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 七、图像通道操作

### 7.1 分离通道

```python
import cv2

img = cv2.imread('photo.jpg')

# 分离BGR通道
b, g, r = cv2.split(img)

# 或使用索引
# b = img[:, :, 0]
# g = img[:, :, 1]
# r = img[:, :, 2]

cv2.imshow('Blue', b)
cv2.imshow('Green', g)
cv2.imshow('Red', r)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 7.2 合并通道

```python
# 合并单通道为彩色图
merged = cv2.merge([b, g, r])

# 只显示红色通道（其他通道置0）
zeros = np.zeros_like(b)
red_only = cv2.merge([zeros, zeros, r])

cv2.imshow('Red Only', red_only)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 7.3 交换通道（BGR → RGB）

```python
import cv2

img = cv2.imread('photo.jpg')

# 方法1：使用split和merge
b, g, r = cv2.split(img)
img_rgb = cv2.merge([r, g, b])

# 方法2：使用cvtColor（推荐）
img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)

# 方法3：使用索引交换
img_rgb = img[:, :, ::-1]  # 反转通道顺序
```

---

## 八、图像算术运算

### 8.1 图像加法

```python
import cv2

img1 = cv2.imread('photo1.jpg')
img2 = cv2.imread('photo2.jpg')

# 确保图像尺寸相同
img2 = cv2.resize(img2, (img1.shape[1], img1.shape[0]))

# 方法1：直接相加（超过255会截断）
result = img1 + img2

# 方法2：使用cv2.add（饱和操作，超过255设为255）
result = cv2.add(img1, img2)

# 方法3：加权相加
result = cv2.addWeighted(img1, 0.7, img2, 0.3, 0)

cv2.imshow('Blended', result)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 8.2 图像减法

```python
import cv2

img1 = cv2.imread('photo1.jpg')
img2 = cv2.imread('photo2.jpg')

# 图像相减（检测差异）
diff = cv2.absdiff(img1, img2)

cv2.imshow('Difference', diff)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 九、综合示例

### 示例：添加水印

```python
import cv2
import numpy as np

# 读取主图像
img = cv2.imread('photo.jpg')
height, width = img.shape[:2]

# 创建水印（半透明白色文字）
overlay = img.copy()
cv2.putText(overlay, 'Watermark', (width - 300, height - 30),
            cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)

# 混合原图和水印（透明度0.5）
result = cv2.addWeighted(img, 0.7, overlay, 0.3, 0)

cv2.imshow('Original', img)
cv2.imshow('Watermarked', result)
cv2.waitKey(0)
cv2.destroyAllWindows()

# 保存
cv2.imwrite('watermarked.jpg', result)
```

### 示例：图片拼贴

```python
import cv2
import numpy as np

img1 = cv2.imread('photo1.jpg')
img2 = cv2.imread('photo2.jpg')

# 调整为相同尺寸
img1 = cv2.resize(img1, (400, 300))
img2 = cv2.resize(img2, (400, 300))

# 水平拼接
h_concat = np.hstack((img1, img2))

# 垂直拼接
v_concat = np.vstack((img1, img2))

cv2.imshow('Horizontal', h_concat)
cv2.imshow('Vertical', v_concat)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 十、常见错误

### 错误1：索引顺序错误

```python
# ❌ 错误
pixel = img[x, y]  # x是列，y是行

# ✅ 正确
pixel = img[y, x]  # 先行后列
```

### 错误2：尺寸不匹配

```python
# ❌ 错误：尺寸不同无法相加
img1 = cv2.imread('photo1.jpg')  # 800x600
img2 = cv2.imread('photo2.jpg')  # 1024x768
result = cv2.add(img1, img2)  # 报错

# ✅ 正确：调整尺寸
img2 = cv2.resize(img2, (img1.shape[1], img1.shape[0]))
result = cv2.add(img1, img2)
```

### 错误3：缩放尺寸顺序错误

```python
# ❌ 错误
resized = cv2.resize(img, (height, width))  # 顺序错误

# ✅ 正确
resized = cv2.resize(img, (width, height))  # 先宽后高
```

---

## 十一、练习题

### 练习1：区域裁剪（⭐）
读取一张图片，裁剪出中心区域（原图尺寸的1/4），并显示。

### 练习2：图像缩放（⭐⭐）
编写函数：
- 输入：图像路径、目标宽度
- 功能：保持宽高比缩放图像
- 输出：缩放后的图像

### 练习3：创建四宫格（⭐⭐）
读取一张图片，创建2x2的缩略图拼贴：
- 左上：原图
- 右上：水平翻转
- 左下：垂直翻转
- 右下：灰度图

### 练习4：通道分离与显示（⭐⭐）
读取彩色图片，分别显示纯红、纯绿、纯蓝通道的图像。

### 练习5：图片边框（⭐⭐⭐）
给图片添加50像素宽的黑色边框。

---

## 十二、扩展思考

1. **为什么图像索引是[y, x]而不是[x, y]？**
   - 提示：矩阵的行列表示法

2. **什么时候使用INTER_AREA vs INTER_CUBIC？**
   - 提示：缩小 vs 放大

3. **如何实现非均匀缩放（只改变宽度或高度）？**

4. **如何检测两张图片的差异？**
   - 提示：使用图像减法

---

**下一步：** 学习[03-色彩空间转换](./03-色彩空间转换.md)
