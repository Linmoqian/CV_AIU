# 色彩空间转换

## 学习目标

- 理解常见的色彩空间（BGR、RGB、HSV、灰度）
- 掌握色彩空间之间的转换方法
- 学会使用HSV色彩空间进行颜色提取
- 理解不同色彩空间的应用场景

---

## 一、色彩空间简介

### 1.1 什么是色彩空间？

**色彩空间（Color Space）**是表示颜色的数学模型。不同的色彩空间有不同的表示方法和应用场景。

### 1.2 常见色彩空间

| 色彩空间 | 表示方式 | 应用场景 |
|---------|---------|---------|
| **BGR/RGB** | 三原色叠加 | 显示设备、图像存储 |
| **灰度（Grayscale）** | 单通道亮度 | 简化计算、边缘检测 |
| **HSV/HSL** | 色调、饱和度、亮度 | 颜色分割、颜色识别 |
| **YCrCb** | 亮度+色度 | 视频压缩、人脸检测 |

---

## 二、BGR与RGB

### 2.1 OpenCV使用BGR

**重要：** OpenCV默认使用**BGR**格式（Blue-Green-Red），而不是常用的RGB！

**示例：**
```python
import cv2
import numpy as np

# 创建一个红色像素（BGR格式）
red_pixel_bgr = [0, 0, 255]  # 蓝色0，绿色0，红色255
print(f"BGR红色: {red_pixel_bgr}")

# 创建一个蓝色像素（BGR格式）
blue_pixel_bgr = [255, 0, 0]  # 蓝色255，绿色0，红色0
print(f"BGR蓝色: {blue_pixel_bgr}")
```

### 2.2 BGR ↔ RGB转换

```python
import cv2

img_bgr = cv2.imread('photo.jpg')

# BGR转RGB（用于matplotlib显示）
img_rgb = cv2.cvtColor(img_bgr, cv2.COLOR_BGR2RGB)

# RGB转BGR
img_bgr2 = cv2.cvtColor(img_rgb, cv2.COLOR_RGB2BGR)

# 使用索引反转（快速方法）
img_rgb = img_bgr[:, :, ::-1]  # 反转通道顺序
```

---

## 三、灰度转换

### 3.1 彩色转灰度

**为什么使用灰度图？**
- 减少计算量（单通道 vs 三通道）
- 简化算法（边缘检测、特征提取）
- 消除颜色干扰

**语法：**
```python
gray = cv2.cvtColor(src, cv2.COLOR_BGR2GRAY)
```

**示例：**
```python
import cv2

img = cv2.imread('photo.jpg')

# 转换为灰度图
gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)

# 或直接读取为灰度图
gray2 = cv2.imread('photo.jpg', cv2.IMREAD_GRAYSCALE)

cv2.imshow('Color', img)
cv2.imshow('Grayscale', gray)
cv2.waitKey(0)
cv2.destroyAllWindows()

# 保存灰度图
cv2.imwrite('gray.jpg', gray)
```

### 3.2 灰度转BGR

```python
import cv2

gray = cv2.imread('gray.jpg', cv2.IMREAD_GRAYSCALE)

# 灰度转BGR（三通道，但看起来还是灰色的）
bgr = cv2.cvtColor(gray, cv2.COLOR_GRAY2BGR)

print(f"灰度图形状: {gray.shape}")  # (height, width)
print(f"BGR图形状: {bgr.shape}")    # (height, width, 3)
```

**应用：**
- 需要三通道输入的算法（如某些深度学习模型）

---

## 四、HSV色彩空间

### 4.1 HSV简介

**HSV**色彩空间更符合人类对颜色的感知：
- **H（Hue）**：色调，颜色种类（0-180°）
- **S（Saturation）**：饱和度，颜色纯度（0-255）
- **V（Value）**：明度，亮度（0-255）

**优势：**
- 对光照变化更鲁棒
- 颜色分割更简单（只需指定H范围）

### 4.2 BGR ↔ HSV转换

```python
import cv2

img = cv2.imread('photo.jpg')

# BGR转HSV
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# HSV转BGR
bgr = cv2.cvtColor(hsv, cv2.COLOR_HSV2BGR)

# 查看HSV值
print(f"HSV图像形状: {hsv.shape}")  # (height, width, 3)
print(f"色调(H)范围: 0-180")
print(f"饱和度(S)范围: 0-255")
print(f"明度(V)范围: 0-255")
```

**⚠️ 注意：**
- OpenCV中H的范围是0-180（不是0-360）
- S和V的范围是0-255

### 4.3 常见颜色的HSV范围

| 颜色 | H范围 | S范围 | V范围 |
|-----|------|------|------|
| 红色 | 0-10 或 170-180 | 100-255 | 100-255 |
| 橙色 | 10-25 | 100-255 | 100-255 |
| 黄色 | 25-35 | 100-255 | 100-255 |
| 绿色 | 35-85 | 100-255 | 100-255 |
| 蓝色 | 85-135 | 100-255 | 100-255 |
| 紫色 | 135-170 | 100-255 | 100-255 |

---

## 五、颜色提取与掩膜

### 5.1 使用inRange()创建掩膜

**语法：**
```python
mask = cv2.inRange(src, lowerb, upperb)
```

**参数：**
- `src`：输入图像（HSV格式）
- `lowerb`：下界（H, S, V）
- `upperb`：上界（H, S, V）

**示例：提取红色**
```python
import cv2
import numpy as np

img = cv2.imread('red-apple.jpg')

# 转换为HSV
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 定义红色的HSV范围
lower_red1 = np.array([0, 100, 100])
upper_red1 = np.array([10, 255, 255])

lower_red2 = np.array([170, 100, 100])
upper_red2 = np.array([180, 255, 255])

# 创建掩膜
mask1 = cv2.inRange(hsv, lower_red1, upper_red1)
mask2 = cv2.inRange(hsv, lower_red2, upper_red2)

# 合并掩膜（红色跨越HSV的0和180）
mask = cv2.bitwise_or(mask1, mask2)

# 应用掩膜
result = cv2.bitwise_and(img, img, mask=mask)

cv2.imshow('Original', img)
cv2.imshow('Mask', mask)
cv2.imshow('Result', result)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 5.2 提取蓝色物体

```python
import cv2
import numpy as np

img = cv2.imread('blue-ball.jpg')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 蓝色HSV范围
lower_blue = np.array([85, 100, 100])
upper_blue = np.array([135, 255, 255])

# 创建掩膜
mask = cv2.inRange(hsv, lower_blue, upper_blue)

# 应用掩膜
result = cv2.bitwise_and(img, img, mask=mask)

cv2.imshow('Blue Detection', result)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 5.3 提取多种颜色

```python
import cv2
import numpy as np

img = cv2.imread('multi-color.jpg')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 定义多个颜色范围
color_ranges = {
    'red': ([0, 100, 100], [10, 255, 255]),
    'green': ([35, 100, 100], [85, 255, 255]),
    'blue': ([85, 100, 100], [135, 255, 255])
}

# 提取每种颜色
for color, (lower, upper) in color_ranges.items():
    lower = np.array(lower)
    upper = np.array(upper)
    mask = cv2.inRange(hsv, lower, upper)
    result = cv2.bitwise_and(img, img, mask=mask)

    cv2.imshow(f'{color.capitalize()} Detection', result)

cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 六、掩膜操作

### 6.1 掩膜的概念

**掩膜（Mask）**是一个二值图像：
- 白色（255）：要保留的区域
- 黑色（0）：要隐藏的区域

### 6.2 掩膜的常用操作

```python
import cv2
import numpy as np

img = cv2.imread('photo.jpg')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 创建掩膜
mask = cv2.inRange(hsv, np.array([0, 100, 100]),
                          np.array([10, 255, 255]))

# 1. 应用掩膜
result = cv2.bitwise_and(img, img, mask=mask)

# 2. 掩膜取反
mask_inv = cv2.bitwise_not(mask)

# 3. 提取掩膜区域
masked_img = img[mask > 0]  # 只提取白色区域的像素

# 4. 统计掩膜区域面积
area = cv2.countNonZero(mask)
print(f"检测到的像素数: {area}")

cv2.imshow('Mask', mask)
cv2.imshow('Result', result)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 6.3 交互式颜色选择器

```python
import cv2

# 定义回调函数
def nothing(x):
    pass

# 创建窗口
cv2.namedWindow('Color Picker')

# 创建滑动条
cv2.createTrackbar('H Low', 'Color Picker', 0, 179, nothing)
cv2.createTrackbar('H High', 'Color Picker', 179, 179, nothing)
cv2.createTrackbar('S Low', 'Color Picker', 0, 255, nothing)
cv2.createTrackbar('S High', 'Color Picker', 255, 255, nothing)
cv2.createTrackbar('V Low', 'Color Picker', 0, 255, nothing)
cv2.createTrackbar('V High', 'Color Picker', 255, 255, nothing)

img = cv2.imread('photo.jpg')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

while True:
    # 获取滑动条位置
    h_l = cv2.getTrackbarPos('H Low', 'Color Picker')
    h_h = cv2.getTrackbarPos('H High', 'Color Picker')
    s_l = cv2.getTrackbarPos('S Low', 'Color Picker')
    s_h = cv2.getTrackbarPos('S High', 'Color Picker')
    v_l = cv2.getTrackbarPos('V Low', 'Color Picker')
    v_h = cv2.getTrackbarPos('V High', 'Color Picker')

    # 创建掩膜
    lower = np.array([h_l, s_l, v_l])
    upper = np.array([h_h, s_h, v_h])
    mask = cv2.inRange(hsv, lower, upper)

    # 应用掩膜
    result = cv2.bitwise_and(img, img, mask=mask)

    # 显示结果
    cv2.imshow('Original', img)
    cv2.imshow('Mask', mask)
    cv2.imshow('Result', result)

    # 按ESC退出
    key = cv2.waitKey(1)
    if key == 27:
        break

cv2.destroyAllWindows()
```

---

## 七、综合应用

### 示例：颜色识别计数器

```python
import cv2
import numpy as np

img = cv2.imread('colored-balls.jpg')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 定义颜色范围
colors = {
    'red': ([0, 100, 100], [10, 255, 255]),
    'green': ([35, 100, 100], [85, 255, 255]),
    'blue': ([85, 100, 100], [135, 255, 255])
}

# 统计每种颜色的数量
for color_name, (lower, upper) in colors.items():
    lower = np.array(lower)
    upper = np.array(upper)

    # 创建掩膜
    mask = cv2.inRange(hsv, lower, upper)

    # 查找轮廓
    contours, _ = cv2.findContours(mask, cv2.RETR_EXTERNAL,
                                   cv2.CHAIN_APPROX_SIMPLE)

    # 绘制轮廓并计数
    count = 0
    for contour in contours:
        area = cv2.contourArea(contour)
        if area > 100:  # 过滤小噪声
            cv2.drawContours(img, [contour], -1, (255, 255, 255), 2)
            count += 1

    print(f"{color_name.capitalize()}: {count} 个")

cv2.imshow('Result', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 八、常见问题

### Q1：为什么颜色提取不准确？

**原因：**
1. 光照影响
2. HSV范围设置不当
3. 颜色渐变

**解决方案：**
```python
# 1. 调整HSV范围
lower = np.array([h - 10, s - 50, v - 50])
upper = np.array([h + 10, s + 50, v + 50])

# 2. 使用形态学操作去噪声
kernel = np.ones((5, 5), np.uint8)
mask = cv2.morphologyEx(mask, cv2.MORPH_CLOSE, kernel)

# 3. 多个范围合并（针对红色等跨越0/180的颜色）
mask = cv2.bitwise_or(mask1, mask2)
```

### Q2：如何获取图像中某个像素的HSV值？

```python
import cv2
import numpy as np

img = cv2.imread('photo.jpg')
hsv = cv2.cvtColor(img, cv2.COLOR_BGR2HSV)

# 点击鼠标获取HSV值
def get_hsv(event, x, y, flags, param):
    if event == cv2.EVENT_LBUTTONDOWN:
        pixel = hsv[y, x]
        print(f"HSV值: H={pixel[0]}, S={pixel[1]}, V={pixel[2]}")

cv2.imshow('image', img)
cv2.setMouseCallback('image', get_hsv)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 九、练习题

### 练习1：基础转换（⭐）
1. 读取一张彩色图片
2. 转换为灰度图并保存
3. 转换为HSV并显示

### 练习2：提取绿色（⭐⭐）
从图片中提取绿色植物区域，显示掩膜和结果。

### 练习3：交通灯识别（⭐⭐⭐）
从交通灯图片中识别红灯、黄灯、绿灯，并在图像上标注。

### 练习4：颜色替换（⭐⭐⭐）
将图片中所有蓝色像素替换为红色。

### 练习5：HSV交互调试器（⭐⭐⭐⭐）
创建一个交互式工具，可以通过滑动条调整HSV范围，实时查看颜色提取效果。

---

## 十、扩展思考

1. **为什么OpenCV中H的范围是0-180而不是0-360？**
   - 提示：uint8存储范围是0-255

2. **什么时候使用HSV而不是RGB？**
   - 颜色分割
   - 对光照变化鲁棒
   - 符合人类感知

3. **如何提高颜色识别的鲁棒性？**
   - 提示：光照归一化、自适应阈值

---

**下一步：** 学习[04-图像绘制](./04-图像绘制.md)
