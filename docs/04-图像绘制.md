# 图像绘制

## 学习目标

- 掌握在图像上绘制基本图形（线条、矩形、圆形）
- 学会添加文字标注
- 理解绘制参数的含义
- 能够创建简单的可视化标注

---

## 一、绘制线条

### 1.1 语法

```python
cv2.line(img, pt1, pt2, color, thickness, lineType, shift)
```

**参数：**
- `img`：要绘制的图像
- `pt1`：起点坐标 (x, y)
- `pt2`：终点坐标 (x, y)
- `color`：颜色 (B, G, R)
- `thickness`：线条粗细（像素），默认1
- `lineType`：线型
  - `cv2.LINE_4`：4连通线
  - `cv2.LINE_8`：8连通线（默认）
  - `cv2.LINE_AA`：抗锯齿线（平滑）

### 1.2 示例

```python
import cv2
import numpy as np

# 创建黑色背景
img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制蓝色线条
cv2.line(img, (0, 0), (511, 511), (255, 0, 0), 5)

# 绘制绿色线条（粗10像素）
cv2.line(img, (0, 511), (511, 0), (0, 255, 0), 10)

# 绘制红色抗锯齿线
cv2.line(img, (100, 100), (400, 100), (0, 0, 255), 3, cv2.LINE_AA)

cv2.imshow('Lines', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 二、绘制矩形

### 2.1 语法

```python
cv2.rectangle(img, pt1, pt2, color, thickness, lineType, shift)
```

**参数：**
- `pt1`：左上角坐标 (x, y)
- `pt2`：右下角坐标 (x, y)
- `color`：颜色 (B, G, R)
- `thickness`：
  - 正数：边框粗细
  - `-1` 或 `cv2.FILLED`：填充矩形

### 2.2 示例

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制蓝色空心矩形（边框粗3像素）
cv2.rectangle(img, (50, 50), (200, 200), (255, 0, 0), 3)

# 绘制绿色填充矩形
cv2.rectangle(img, (250, 50), (400, 200), (0, 255, 0), -1)

# 绘制红色边框矩形
cv2.rectangle(img, (100, 300), (400, 450), (0, 0, 255), 5)

cv2.imshow('Rectangles', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 三、绘制圆形

### 3.1 语法

```python
cv2.circle(img, center, radius, color, thickness, lineType, shift)
```

**参数：**
- `center`：圆心坐标 (x, y)
- `radius`：半径（像素）
- `color`：颜色 (B, G, R)
- `thickness`：
  - 正数：边框粗细
  - `-1` 或 `cv2.FILLED`：填充圆形

### 3.2 示例

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制蓝色空心圆
cv2.circle(img, (256, 256), 100, (255, 0, 0), 3)

# 绘制绿色填充圆
cv2.circle(img, (100, 100), 50, (0, 255, 0), -1)

# 绘制红色空心圆（粗边框）
cv2.circle(img, (400, 400), 80, (0, 0, 255), 5)

cv2.imshow('Circles', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 四、绘制椭圆

### 4.1 语法

```python
cv2.ellipse(img, center, axes, angle, startAngle, endAngle,
            color, thickness, lineType, shift)
```

**参数：**
- `center`：中心坐标 (x, y)
- `axes`：长短轴 (长轴, 短轴)
- `angle`：旋转角度（度）
- `startAngle`：起始角度（度）
- `endAngle`：结束角度（度）
- `color`：颜色 (B, G, R)
- `thickness`：粗细或填充

### 4.2 示例

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制完整椭圆
cv2.ellipse(img, (256, 256), (150, 100), 0, 0, 360,
            (255, 0, 0), 2)

# 绘制半椭圆
cv2.ellipse(img, (100, 400), (80, 50), 45, 0, 180,
            (0, 255, 0), -1)

# 绘制旋转椭圆
cv2.ellipse(img, (400, 100), (100, 60), 30, 0, 360,
            (0, 0, 255), 3)

cv2.imshow('Ellipses', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 五、绘制多边形

### 5.1 语法

```python
cv2.polylines(img, pts, isClosed, color, thickness, lineType, shift)
```

**参数：**
- `pts`：点集数组，形状为 (n, 1, 2)
- `isClosed`：是否闭合多边形
- `color`：颜色 (B, G, R)
- `thickness`：线条粗细

### 5.2 示例

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 定义多边形的顶点
pts = np.array([[100, 150], [200, 50], [400, 150],
                [350, 300], [150, 300]], dtype=np.int32)

# 重塑为 (n, 1, 2) 形状
pts = pts.reshape((-1, 1, 2))

# 绘制闭合多边形
cv2.polylines(img, [pts], True, (255, 0, 0), 3)

# 绘制三角形
triangle = np.array([[50, 400], [150, 350], [100, 450]],
                    dtype=np.int32)
triangle = triangle.reshape((-1, 1, 2))
cv2.polylines(img, [triangle], True, (0, 255, 0), 2)

cv2.imshow('Polygons', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 5.3 填充多边形

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 定义多边形顶点
pts = np.array([[100, 150], [200, 50], [400, 150],
                [350, 300], [150, 300]], dtype=np.int32)
pts = pts.reshape((-1, 1, 2))

# 填充多边形
cv2.fillPoly(img, [pts], (255, 0, 255))

cv2.imshow('Filled Polygon', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 六、添加文字

### 6.1 语法

```python
cv2.putText(img, text, org, fontFace, fontScale, color,
            thickness, lineType, bottomLeftOrigin)
```

**参数：**
- `text`：要绘制的文字字符串
- `org`：文字左下角坐标 (x, y)
- `fontFace`：字体类型
  - `cv2.FONT_HERSHEY_SIMPLEX`：正常尺寸无衬线
  - `cv2.FONT_HERSHEY_PLAIN`：小尺寸无衬线
  - `cv2.FONT_HERSHEY_DUPLEX`：正常尺寸无衬线（比SIMPLEX复杂）
  - `cv2.FONT_HERSHEY_COMPLEX`：正常尺寸有衬线
  - `cv2.FONT_HERSHEY_TRIPLEX`：正常尺寸有衬线（更复杂）
  - `cv2.FONT_HERSHEY_SCRIPT_SIMPLEX`：手写风格
  - `cv2.FONT_HERSHEY_SCRIPT_COMPLEX`：更复杂手写风格
- `fontScale`：字体大小（乘数因子）
- `color`：颜色 (B, G, R)
- `thickness`：线条粗细
- `lineType`：线型（`cv2.LINE_AA`推荐）

### 6.2 示例

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制白色文字
cv2.putText(img, 'Hello OpenCV!', (50, 100),
            cv2.FONT_HERSHEY_SIMPLEX, 1, (255, 255, 255), 2)

# 绘制蓝色大文字
cv2.putText(img, 'Big Text', (50, 200),
            cv2.FONT_HERSHEY_SIMPLEX, 2, (255, 0, 0), 3)

# 绘制绿色小文字
cv2.putText(img, 'Small Text', (50, 300),
            cv2.FONT_HERSHEY_PLAIN, 1, (0, 255, 0), 1)

# 绘制抗锯齿文字（推荐）
cv2.putText(img, 'Smooth Text', (50, 400),
            cv2.FONT_HERSHEY_SIMPLEX, 1.5, (0, 0, 255), 2,
            cv2.LINE_AA)

cv2.imshow('Text', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 6.3 中文文字支持

**问题：** OpenCV的`putText()`不支持中文！

**解决方案：** 使用PIL库

```python
import cv2
import numpy as np
from PIL import ImageFont, ImageDraw, Image

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 转换为PIL图像
img_pil = Image.fromarray(cv2.cvtColor(img, cv2.COLOR_BGR2RGB))

# 绘制中文
draw = ImageDraw.Draw(img_pil)
font = ImageFont.truetype('msyh.ttc', 32)  # 微软雅黑
draw.text((50, 100), '你好，OpenCV！', font=font, fill=(255, 255, 255))

# 转换回OpenCV格式
img = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR)

cv2.imshow('中文', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 七、综合应用

### 示例1：绘制箭头

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制箭头
cv2.arrowedLine(img, (50, 50), (200, 200), (255, 0, 0), 5,
                cv2.LINE_AA, 0, 0.1)

cv2.arrowedLine(img, (300, 50), (300, 200), (0, 255, 0), 5,
                tipLength=0.3)

cv2.imshow('Arrow', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 示例2：绘制网格

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

# 绘制网格线
spacing = 50  # 网格间距

# 垂直线
for x in range(0, 512, spacing):
    cv2.line(img, (x, 0), (x, 511), (100, 100, 100), 1)

# 水平线
for y in range(0, 512, spacing):
    cv2.line(img, (0, y), (511, y), (100, 100, 100), 1)

cv2.imshow('Grid', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 示例3：绘制标注框

```python
import cv2

img = cv2.imread('photo.jpg')

# 绘制检测框
cv2.rectangle(img, (100, 100), (300, 300), (0, 255, 0), 2)

# 添加标签背景
cv2.rectangle(img, (100, 70), (200, 100), (0, 255, 0), -1)

# 添加标签文字
cv2.putText(img, 'Object', (105, 95),
            cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 0), 1,
            cv2.LINE_AA)

cv2.imshow('Detection', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 示例4：创建标定板图案

```python
import cv2
import numpy as np

# 创建8x8黑白棋盘格
square_size = 100
board_size = 8
img_size = square_size * board_size

img = np.zeros((img_size, img_size), dtype=np.uint8)

for i in range(board_size):
    for j in range(board_size):
        if (i + j) % 2 == 0:
            y1, y2 = i * square_size, (i + 1) * square_size
            x1, x2 = j * square_size, (j + 1) * square_size
            img[y1:y2, x1:x2] = 255

cv2.imshow('Checkerboard', img)
cv2.imwrite('checkerboard.png', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 八、绘制最佳实践

### 8.1 颜色定义

```python
# 常用颜色定义
COLORS = {
    'black': (0, 0, 0),
    'white': (255, 255, 255),
    'red': (0, 0, 255),
    'green': (0, 255, 0),
    'blue': (255, 0, 0),
    'yellow': (0, 255, 255),
    'cyan': (255, 255, 0),
    'magenta': (255, 0, 255)
}

# 使用
cv2.rectangle(img, (10, 10), (100, 100), COLORS['blue'], 2)
```

### 8.2 抗锯齿

```python
# 推荐使用抗锯齿（LINE_AA）获得平滑效果
cv2.line(img, (0, 0), (511, 511), (255, 0, 0), 3, cv2.LINE_AA)
cv2.putText(img, 'Text', (50, 50), cv2.FONT_HERSHEY_SIMPLEX,
            1, (0, 0, 255), 2, cv2.LINE_AA)
```

### 8.3 文字居中

```python
import cv2
import numpy as np

img = np.zeros((512, 512, 3), dtype=np.uint8)

text = "Centered Text"
font = cv2.FONT_HERSHEY_SIMPLEX
font_scale = 1
thickness = 2

# 获取文字大小
(text_width, text_height), baseline = cv2.getTextSize(
    text, font, font_scale, thickness)

# 计算居中位置
text_x = (img.shape[1] - text_width) // 2
text_y = (img.shape[0] + text_height) // 2

# 绘制居中文字
cv2.putText(img, text, (text_x, text_y), font,
            font_scale, (255, 255, 255), thickness, cv2.LINE_AA)

cv2.imshow('Centered Text', img)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 九、常见错误

### 错误1：坐标顺序错误

```python
# ❌ 错误
cv2.rectangle(img, (y1, x1), (y2, x2), color, 2)  # 顺序错误

# ✅ 正确
cv2.rectangle(img, (x1, y1), (x2, y2), color, 2)  # 先x后y
```

### 错误2：颜色顺序错误

```python
# ❌ 错误（使用RGB）
cv2.rectangle(img, (10, 10), (100, 100), (255, 0, 0), 2)  # 这是蓝色

# ✅ 正确（使用BGR）
cv2.rectangle(img, (10, 10), (100, 100), (0, 0, 255), 2)  # 这是红色
```

### 错误3：多边形点集形状错误

```python
# ❌ 错误
pts = np.array([[100, 150], [200, 50], [300, 150]])
cv2.polylines(img, [pts], True, color, 2)  # 形状错误

# ✅ 正确
pts = np.array([[100, 150], [200, 50], [300, 150]], dtype=np.int32)
pts = pts.reshape((-1, 1, 2))  # 重塑为 (n, 1, 2)
cv2.polylines(img, [pts], True, color, 2)
```

---

## 十、练习题

### 练习1：基础图形（⭐）
在黑色背景上绘制：
- 一个蓝色矩形
- 一个绿色圆形
- 一条红色对角线

### 练习2：绘制靶心（⭐⭐）
绘制一个由5个同心圆组成的靶心图案（交替红白）。

### 练习3：绘制表格（⭐⭐）
绘制一个5行5列的表格，单元格大小为100x100像素。

### 练习4：绘制人脸框架（⭐⭐）
模拟人脸检测标注：
- 绘制矩形框
- 在框上方添加标签（如"Face"）
- 显示置信度分数

### 练习5：绘制流程图（⭐⭐⭐）
使用OpenCV绘制一个简单的流程图（包含矩形框、箭头、文字）。

---

## 十一、扩展思考

1. **如何绘制虚线？**
   - 提示：OpenCV没有直接方法，需要分段绘制

2. **如何测量文字的宽度和高度？**
   - 提示：使用`cv2.getTextSize()`

3. **为什么推荐使用cv2.LINE_AA？**
   - 提示：抗锯齿效果

---

**下一步：** 学习[05-图像滤波与增强](./05-图像滤波与增强.md)
