# 形态学操作

## 学习目标

- 理解形态学操作的基本概念
- 掌握腐蚀和膨胀操作
- 学会开运算和闭运算
- 了解形态学操作的应用场景

---

## 一、形态学操作简介

### 1.1 什么是形态学操作？

**形态学操作（Morphological Operations）**是基于图像形状的变换，主要用于：
- 去除噪声
- 填充孔洞
- 连接断开的区域
- 分离连接的对象

### 1.2 核心元素：结构元素（Kernel）

**结构元素**是一个小矩阵，用于探测图像形状。

**示例：3x3矩形核**
```python
kernel = np.ones((3, 3), np.uint8)
```

**创建核的方法：**
```python
import cv2
import numpy as np

# 矩形核
kernel_rect = cv2.getStructuringElement(cv2.MORPH_RECT, (5, 5))

# 椭圆核
kernel_ellipse = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (5, 5))

# 十字核
kernel_cross = cv2.getStructuringElement(cv2.MORPH_CROSS, (5, 5))
```

---

## 二、腐蚀（Erosion）

### 2.1 原理

**腐蚀**：用结构元素的最小值替换中心像素。

**效果：**
- 白色区域缩小
- 去除小的白色噪声
- 断开连接的对象

### 2.2 语法

```python
dst = cv2.erode(src, kernel, iterations)
```

**参数：**
- `kernel`：结构元素
- `iterations`：迭代次数（默认1）

### 2.3 示例

```python
import cv2
import numpy as np

img = cv2.imread('binary.jpg', cv2.IMREAD_GRAYSCALE)

# 创建核
kernel = np.ones((5, 5), np.uint8)

# 腐蚀
erosion = cv2.erode(img, kernel, iterations=1)

# 多次腐蚀
erosion_3 = cv2.erode(img, kernel, iterations=3)

cv2.imshow('Original', img)
cv2.imshow('Erosion 1x', erosion)
cv2.imshow('Erosion 3x', erosion_3)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 三、膨胀（Dilation）

### 3.1 原理

**膨胀**：用结构元素的最大值替换中心像素。

**效果：**
- 白色区域扩大
- 填充小的黑色孔洞
- 连接断开的对象

### 3.2 语法

```python
dst = cv2.dilate(src, kernel, iterations)
```

**参数：**
- `kernel`：结构元素
- `iterations`：迭代次数（默认1）

### 3.3 示例

```python
import cv2
import numpy as np

img = cv2.imread('binary.jpg', cv2.IMREAD_GRAYSCALE)

kernel = np.ones((5, 5), np.uint8)

# 膨胀
dilation = cv2.dilate(img, kernel, iterations=1)

# 多次膨胀
dilation_3 = cv2.dilate(img, kernel, iterations=3)

cv2.imshow('Original', img)
cv2.imshow('Dilation 1x', dilation)
cv2.imshow('Dilation 3x', dilation_3)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 四、开运算

### 4.1 原理

**开运算 = 先腐蚀后膨胀**

**效果：**
- 去除小的白色噪声
- 保持原有区域大小基本不变

### 4.2 语法

```python
dst = cv2.morphologyEx(src, cv2.MORPH_OPEN, kernel)
```

### 4.3 示例

```python
import cv2
import numpy as np

img = cv2.imread('noisy-binary.jpg', cv2.IMREAD_GRAYSCALE)

kernel = np.ones((5, 5), np.uint8)

# 开运算
opening = cv2.morphologyEx(img, cv2.MORPH_OPEN, kernel)

cv2.imshow('Original', img)
cv2.imshow('Opening', opening)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 五、闭运算

### 5.1 原理

**闭运算 = 先膨胀后腐蚀**

**效果：**
- 填充小的黑色孔洞
- 连接断开的对象

### 5.2 语法

```python
dst = cv2.morphologyEx(src, cv2.MORPH_CLOSE, kernel)
```

### 5.3 示例

```python
import cv2
import numpy as np

img = cv2.imread('holes.jpg', cv2.IMREAD_GRAYSCALE)

kernel = np.ones((5, 5), np.uint8)

# 闭运算
closing = cv2.morphologyEx(img, cv2.MORPH_CLOSE, kernel)

cv2.imshow('Original', img)
cv2.imshow('Closing', closing)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 六、形态学梯度

### 6.1 原理

**形态学梯度 = 膨胀 - 腐蚀**

**效果：**
- 突出边缘
- 类似边缘检测

### 6.2 语法

```python
dst = cv2.morphologyEx(src, cv2.MORPH_GRADIENT, kernel)
```

### 6.3 示例

```python
import cv2
import numpy as np

img = cv2.imread('binary.jpg', cv2.IMREAD_GRAYSCALE)

kernel = np.ones((3, 3), np.uint8)

# 形态学梯度
gradient = cv2.morphologyEx(img, cv2.MORPH_GRADIENT, kernel)

cv2.imshow('Original', img)
cv2.imshow('Gradient', gradient)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 七、顶帽和黑帽

### 7.1 顶帽（Top Hat）

**顶帽 = 原图 - 开运算**

**效果：**
- 提取比邻域亮的区域
- 检测小的亮斑点

```python
tophat = cv2.morphologyEx(img, cv2.MORPH_TOPHAT, kernel)
```

### 7.2 黑帽（Black Hat）

**黑帽 = 闭运算 - 原图**

**效果：**
- 提取比邻域暗的区域
- 检测小的暗斑点

```python
blackhat = cv2.morphologyEx(img, cv2.MORPH_BLACKHAT, kernel)
```

### 7.3 示例

```python
import cv2
import numpy as np

img = cv2.imread('photo.jpg', cv2.IMREAD_GRAYSCALE)

kernel = np.ones((9, 9), np.uint8)

# 顶帽
tophat = cv2.morphologyEx(img, cv2.MORPH_TOPHAT, kernel)

# 黑帽
blackhat = cv2.morphologyEx(img, cv2.MORPH_BLACKHAT, kernel)

cv2.imshow('Original', img)
cv2.imshow('Top Hat', tophat)
cv2.imshow('Black Hat', blackhat)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 八、综合应用

### 示例1：去噪流程

```python
import cv2
import numpy as np

img = cv2.imread('noisy.jpg', cv2.IMREAD_GRAYSCALE)

# 阈值
ret, thresh = cv2.threshold(img, 127, 255, cv2.THRESH_BINARY)

kernel = np.ones((3, 3), np.uint8)

# 开运算（去白噪声）
opening = cv2.morphologyEx(thresh, cv2.MORPH_OPEN, kernel)

# 闭运算（填黑孔洞）
closing = cv2.morphologyEx(opening, cv2.MORPH_CLOSE, kernel)

cv2.imshow('Original', thresh)
cv2.imshow('Opening', opening)
cv2.imshow('Closing', closing)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 示例2：提取文字区域

```python
import cv2
import numpy as np

img = cv2.imread('text.jpg', cv2.IMREAD_GRAYSCALE)

# 阈值
ret, thresh = cv2.threshold(img, 0, 255,
                           cv2.THRESH_BINARY_INV + cv2.THRESH_OTSU)

# 水平膨胀（连接字符）
kernel_horizontal = np.ones((1, 10), np.uint8)
dilated = cv2.dilate(thresh, kernel_horizontal, iterations=1)

# 查找轮廓
contours, _ = cv2.findContours(dilated, cv2.RETR_EXTERNAL,
                               cv2.CHAIN_APPROX_SIMPLE)

# 绘制矩形框
result = cv2.cvtColor(img, cv2.COLOR_GRAY2BGR)
for contour in contours:
    x, y, w, h = cv2.boundingRect(contour)
    if w > 50 and h > 20:  # 过滤小噪声
        cv2.rectangle(result, (x, y), (x + w, y + h), (0, 255, 0), 2)

cv2.imshow('Result', result)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

### 示例3：边缘提取

```python
import cv2
import numpy as np

img = cv2.imread('shape.jpg', cv2.IMREAD_GRAYSCALE)

# 阈值
ret, thresh = cv2.threshold(img, 127, 255, cv2.THRESH_BINARY)

kernel = np.ones((3, 3), np.uint8)

# 形态学梯度
gradient = cv2.morphologyEx(thresh, cv2.MORPH_GRADIENT, kernel)

cv2.imshow('Original', img)
cv2.imshow('Gradient', gradient)
cv2.waitKey(0)
cv2.destroyAllWindows()
```

---

## 九、常见问题

### Q1：如何选择核大小？

**经验法则：**
- 噪声小 → 核大小3-5
- 噪声大 → 核大小7-15
- 根据目标尺寸调整

### Q2：开运算和闭运算如何选择？

| 操作 | 用途 |
|-----|------|
| **开运算** | 去除白色噪声 |
| **闭运算** | 填充黑色孔洞 |
| **先用开后用闭** | 先去噪后填充 |

### Q3：为什么形态学操作后效果不好？

**检查：**
1. 是否是二值图像？
2. 颜色是否正确（白色为前景）？
3. 核大小是否合适？

---

## 十、练习题

### 练习1：基础操作（⭐）
1. 读取一张二值图
2. 分别进行腐蚀和膨胀
3. 对比效果

### 练习2：去噪（⭐⭐）
1. 读取带噪声的二值图
2. 使用开运算去除噪声
3. 使用闭运算填充孔洞

### 练习3：边缘提取（⭐⭐）
使用形态学梯度提取图像边缘。

### 练习4：文字分割（⭐⭐⭐）
从文档图片中提取文字行（使用膨胀+轮廓查找）。

### 练习5：细胞计数（⭐⭐⭐⭐）
统计显微镜图像中的细胞数量（使用开运算+轮廓查找）。

---

## 十一、扩展思考

1. **为什么开运算能去噪声？**
   - 提示：先腐蚀去除小点，后膨胀恢复大小

2. **形态学操作和滤波有什么区别？**
   - 提示：基于形状 vs 基于数值

3. **如何处理彩色图像的形态学操作？**
   - 提示：分别处理每个通道

---

**下一步：** 学习[08-实战项目教程](./08-实战项目教程.md)
